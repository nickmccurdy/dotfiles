#!/bin/bash

usage() {
  cat << EOF
usage: $0 [<options>]

Finds git repos in the current directory (recursively) and shows their branch,
status, push/pull status, and stashes.

OPTIONS:
   -h      Show this message
   -n      Only display names of repos
EOF
}

repo_is_dirty() {
  ! git diff-index --quiet HEAD --
}

NAMES_ONLY=

while getopts "hn" OPTION; do
  case $OPTION in
    h)
      usage
      exit 1
      ;;
    n)
      NAMES_ONLY=1
      ;;
  esac
done

for git_dir in `find -L . -type d -name .git` ; do
  pushd `dirname $git_dir` > /dev/null
  if repo_is_dirty; then
    if [[ $NAMES_ONLY ]]; then
      # Displays the repo's path.
      pwd
    else
      # Displays the repo's path, its (short) status, and its stashes.
      echo "`pwd`:"
      git status --short --branch
      git stash list
      echo
    fi
  fi
  popd > /dev/null
done
